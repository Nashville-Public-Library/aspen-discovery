#!/bin/bash
set -e

echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#+*#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%*=:::-+#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#=-::::::::-*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#+::::-=-::=-::::-*#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#+-::::=*%#=::+%#+-::::=*#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%+-::::::#%%%#=::+%%%%+::::::=#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#=::::=#-::=#%%#=::+%%%*-::++-:::-+#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#+-:::-*#%%#-::-*%#=::+%%+:::+#%%#=::::-*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%#=::::::*%%%%%#=:::=#=::+*-:::*%%%%%%-:::::-*%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%#+:::-*=::-#%%%%%%#-:::-::-:::=#%%%%%%*::-*=-::-*%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%+-::-*#%#-::-#%%%%%%#+:::::::-*%%%%%%%*-:-+%%#=:::=#%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%#=:::-#%%%%#=::-*%%%%%%%#-::::+%%%%%%%%=:::+%%%%%+:::-+%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%*-::-::*%%%%%%+-::=#%%%%%%#-:-=%%%%%%%*-::-#%%%%%#-::-::=#%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%+---+*---*%%%%%%#=---*%%%%%#=--+%%%%%#=---+#%%%%%#=---*----#%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%*---+%%+---+%%%%%%#+---=#%%%#=--+%%%%*----#%%%%%%#=---#%#=--=#%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%#---+%%%%*---=#%%%%%%#=---+%%#=--+%%#=---+%%%%%%%*----#%%%#=--=#%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%---=%%%%%%#=---*%%%%%%#*---=##=--+%*---=#%%%%%%#+---+%%%%%%#---*%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%+---#%%%%%%%#+---=%%%%%%%#=---*=--++---*%%%%%%%#----#%%%%%%%%=---%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%#----+***++=--------*%%%%%%%+----------*%%%%%%#=--------=++***----*%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%*--------------------=#%%%%%%+--------#%%%%%%*--------------------=%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%*--=##########%%%##----*%%%%%%*-----=#%%%%%#=---+##%%%#########*---#%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%+--=#%%%%%%%%%%%%%%%*---=#%%%%%+----#%%%%%*---=#%%%%%%%%%%%%%%%*---#%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%+--=#%%%%%%%%%%%###**+----*%%%%#=--+%%%%#+---=***###%%%%%%%%%%%*---#%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%*---*%%%##*+==-------------+#%%#=--+%%%*=------------===+*#%%%#=---#%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%*=-------------===+***+==---=#%#=--+%%*----=++**++==--------------=%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%#=--=+=+++**#%%%%%%%%%%%%#=--=##=--+#+---*#%%%%%%%%%%%##*+++==+---*%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%*---#%%%%%%%%%%%%%%%%%%%%%+---+=-=++--=#%%%%%%%%%%%%%%%%%%%%%+--=%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%+===#%%%%%%%%%%%%%#+=-===--===-=-=-======-=+*##%%%%%%%%%%%%+=-=#%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%#+===+#####**+===================================++*#####*+===*%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%*==============+*###%%%%##=======+#%%%%%###*+==============#%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%#======+**#%%%%%%%%%%%%%%%+====*%%%%%%%%%%%%%%%#*+======*%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%#+=====+*##%%%%%%%%%%%%%#===+#%%%%%%%%%%%%##*+=====+*#%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%#*========++++++++***#+==*#**++++++++========+*#%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%##+++++++++++++++++++++++++++++++++++*#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#######*++++++*#######%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#*++*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#*++*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#*++*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#*++*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#**%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
echo "%"
echo "%   Aspen Discovery starting for: ${SITE_NAME}"
echo "%"

export CONFIG_DIRECTORY="/usr/local/aspen-discovery/sites/$SITE_NAME"

# Move to docker directory
cd "/usr/local/aspen-discovery/docker/files/scripts" || exit

# Check if site configuration exists
confSiteFile="$CONFIG_DIRECTORY/conf/config.ini"
if [ ! -f "$confSiteFile" ] ; then
	echo "%   * $confSiteFile not found, generating"
	mkdir -p "$CONFIG_DIRECTORY"
	if ! php createConfig.php "$CONFIG_DIRECTORY" ; then
		echo "%   ERROR: Failed to create instance config"
		exit 1
	fi
fi

# Initialize Aspen database
echo "%   * Initializing database";
if ! php initDatabase.php ; then
	echo "%   ERROR: Database initialization failed"
	exit 1
fi

# Initialize Koha Connection
echo "%   * Initializing Koha link";
if ! php initKohaLink.php ; then
	echo "%   ERROR: Koha link error"
	exit 1
fi

# Create missing dirs and fix ownership and permissions if needed
echo "%   * Setting up data and log directories";
if ! php createDirs.php ; then
	echo "%   ERROR: Directories creation and permission fixes failed"
	exit 1
fi

# FIXME: This seems to be creating dirs like images/images, etc
#        It should be put outside the codebase, and mounted accordingly

# Move and create temporarily sym-links to data directory
dataDir="/data/aspen-discovery/$SITE_NAME"
localDir="/usr/local/aspen-discovery/code/web"

directories=(files images fonts)
for dir in "${directories[@]}"; do

	source="$localDir/$dir"
    dest="$dataDir/$dir"

    # Ensure persistent target directory exists
    mkdir -p "$dest"

    # Move original data only if target is empty
    if [ -d "$source" ] && [ "$(ls -A "$dest")" == "" ]; then
        mv "$source"/* "$dest"/
    fi

    # Remove the source directory or symlink
	rm -rf "$source"

    # Create symlink
    ln -s "$dest" "$source"

	echo "%   * Created symlink: $source â†’ $dest"
done

# Check if data-alias.conf is enabled 
file="/etc/apache2/conf-enabled/data-alias.conf"
if [ ! -f "$file"  ]; then
	a2enconf data-alias
fi

echo "%   * Starting Apache"
# Start apache
service apache2 start

# Run any pending database updates
echo "127.0.0.1    $SITE_NAME" >> /etc/hosts
echo "%   * Triggering pending database updates"
curl -k http://"$SITE_NAME"/API/SystemAPI?method=runPendingDatabaseUpdates

sudo -u www-data	php /usr/local/aspen-discovery/docker/files/cron/checkBackgroundProcessesDocker.php $SITE_NAME >/proc/1/fd/1 2>/proc/1/fd/2

echo "%"
echo "%   Aspen Discovery ready to use!"
echo "%"
echo "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"


# FIXME: We should probably run Apache in foreground instead. We need to
#        figure an approach to the curl above in order to do it
/bin/bash -c "trap : TERM INT; sleep infinity & wait"
